var userApprovalMod=angular.module("UserApprovalMod",[]);userApprovalMod.controller("UserApprovalCtrl",["$scope","UserApprovalService","$rootScope","$window","$state",function(c,b,a,e,d){c.showACSDatePicker=function(){setTimeout(function(){var f=$("#acsdatepicker").val();$("#acsdatepicker")[g(f)]("x");$("#acsdatepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:true,changeYear:true,minDate:0});$("#acsdatepicker").change(function(){var h=$("#acsdatepicker").val();console.log("in change :: "+h);$("#acsdatepicker")[g(h)]("x")});function g(h){return h?"addClass":"removeClass"}$(document).on("input",".clearable",function(){$(this)[g(this.value)]("x")}).on("mousemove",".x",function(h){$(this)[g(this.offsetWidth-18<h.clientX-this.getBoundingClientRect().left)]("onX")}).on("touchstart click",".onX",function(h){h.preventDefault();$(this).removeClass("x onX").val("").change()});$("#acsdatepicker").keydown(function(){var i=window.event;var h=i.keyCode||i.which;if(h===9||h===16){return}else{return false}})})};c.showTDSDatePicker=function(){setTimeout(function(){var f=$("#threedsdatepicker").val();$("#threedsdatepicker")[g(f)]("x");$("#threedsdatepicker").datepicker({dateFormat:"yy-mm-dd",changeMonth:true,changeYear:true,minDate:0});$("#threedsdatepicker").change(function(){var h=$("#threedsdatepicker").val();console.log("in change :: "+h);$("#threedsdatepicker")[g(h)]("x")});function g(h){return h?"addClass":"removeClass"}$(document).on("input",".clearable",function(){$(this)[g(this.value)]("x")}).on("mousemove",".x",function(h){$(this)[g(this.offsetWidth-18<h.clientX-this.getBoundingClientRect().left)]("onX")}).on("touchstart click",".onX",function(h){h.preventDefault();$(this).removeClass("x onX").val("").change()});$("#threedsdatepicker").keydown(function(){var i=window.event;var h=i.keyCode||i.which;if(h===9||h===16){return}else{return false}})})};c.pit2components=[{id:"ACS",value:"ACS",selected:false},{id:"3DS Server",value:"MRCH",selected:false}];c.notes="";c.loading=false;c.isPIT2ACS=false;c.isMerchant=false;c.isPageLoading=false;c.isRejected=false;c.getCountries=function(){b.getCountries().then(function(f){c.countries=f.data;c.getUserDetails()})};c.getUserDetails=function(){console.log("User activation token :: "+a.token);c.pit1SelectedComponents=[];c.selectedVersions=[];c.pit2SelectedComponents=[];c.userToken=a.token;c.isPageLoading=true;b.getEnrolledUserDetails(c.userToken).then(function f(h){c.isPageLoading=false;var i=h.data;c.userEmail=i.emailAddr;c.name=i.usrNm;c.company=i.coNm;c.streetAddress=i.str1Addr;c.city=i.cityNm;c.country=i.ctryCd;c.phone=i.phnNum;c.bin=i.bin;c.merchantRefNum=i.mrchRefNum;c.pit2ACSUrl=i.pit2Url;c.emvCertificate=i.emvCertificate;c.componentID=i.componentID;c.isActive=i.actvInd;c.firstName=i.firstName;c.lastName=i.lastName;c.stateOrTerritory=i.stateORTerritory,c.postalCode=i.postalCode;c.acquirerBin=i.acquirerBin;c.acsReference=i.acsReference;c.merchantId=i.mrchId;c.businessId=i.businessId;if(!c.isActive&&i.notes!=null&&i.notes!=""){c.isRejected=true}c.notes=i.notes;angular.forEach(i.userRoles,function(k){if(k!="ADMIN"){var j=k.split("_");if(c.selectedVersions!=null&&c.selectedVersions.length>0){if(c.selectedVersions.indexOf(j[0])==-1){c.selectedVersions.push(j[0])}}else{c.selectedVersions.push(j[0])}if(j[0]=="PIT1"){c.pit1SelectedComponents.push(j[1])}else{if(j[0]=="PIT2"){c.pit2SelectedComponents.push(j[1])}}}else{c.admin=true}});angular.forEach(c.pit2components,function(j){if(c.pit2SelectedComponents.indexOf(j.value)!=-1){if(j.value==COMPONENTS.ACS){c.isPIT2ACS=true;j.selected=true}else{if(j.value==COMPONENTS.MRCH){c.isMerchant=true;j.selected=true}else{j.selected=false}}}});c.showACSDatePicker();c.showTDSDatePicker()},function g(h){c.isPageLoading=false;a.showSuccessAlert=false;a.showErrorAlert=true;if(errorResonse.data.errorMessage!=null&&errorResonse.data.errorMessage!=""){a.errorMessage=errorResonse.data.errorMessage}else{a.errorMessage="Invalid user email"}})};c.getCountries();c.isApprove=false;c.acsEMVCoValidity="";c.threeDSEMVCoValidity="";c.confirmApproval=function(){c.isReject=false;if((c.isPIT2ACS&&(c.acsEMVCoValidity==undefined||c.acsEMVCoValidity==""))||(c.isMerchant&&(c.threeDSEMVCoValidity==undefined||c.threeDSEMVCoValidity==""))){c.isApprove=true;return}else{c.isApprove=false}if(e.confirm("Are you sure, you want to approve the enrollment of "+c.firstName)){c.approveUser()}};c.confirmRejection=function(){c.isApprove=false;if(c.notes==undefined||c.notes==""){c.isReject=true;return}else{c.isReject=false}if(e.confirm("Are you sure, you want to reject the enrollment of "+c.firstName)){c.rejectUser()}};c.approveUser=function(){var h={enrollmentToken:a.token,notes:c.notes,acsEMVCoValidity:c.acsEMVCoValidity,threeDSEMVCoValidity:c.threeDSEMVCoValidity,userFirstName:c.firstName,userEmail:c.userEmail};c.loading=true;b.approveUser(h).then(function f(i){c.loading=false;a.showSuccessAlert=true;a.showErrorAlert=false;a.successMessage=i.data.successMessage;c.isActive=true;delete a.token;e.scrollTo(0,0)},function g(i){c.loading=false;a.showErrorAlert=true;a.showSuccessAlert=false;if(i.data.errorMessage!=null&&i.data.errorMessage!=undefined){a.errorMessage=i.data.errorMessage}else{a.errorMessage="Failed to approve user."}e.scrollTo(0,0)})};c.rejectUser=function(){var h={enrollmentToken:a.token,notes:c.notes,acsEMVCoValidity:c.acsEMVCoValidity,threeDSEMVCoValidity:c.threeDSEMVCoValidity,userFirstName:c.firstName,userEmail:c.userEmail};c.loading=true;b.rejectUser(h).then(function f(i){c.loading=false;a.showErrorAlert=false;a.showSuccessAlert=true;a.successMessage=i.data.successMessage;c.isRejected=true;delete a.token;e.scrollTo(0,0)},function g(i){c.loading=false;a.showSuccessAlert=false;a.showErrorAlert=true;if(i.data.errorMessage!=null&&i.data.errorMessage!=undefined){a.errorMessage=i.data.errorMessage}else{a.errorMessage="Failed to reject user."}e.scrollTo(0,0)})};c.cancelApproval=function(){if(a.redirectFromVendorLog){d.go("PIT2.vendorLog")}else{d.go("login")}};c.backtoVendorLogScreen=function(){d.go("PIT2.vendorLog")}}]);